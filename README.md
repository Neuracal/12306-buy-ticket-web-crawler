# 12306-buy-ticket-web-crawler

这里是一个可以在12306购票的脚本程序，主要采用Python中的requests库来爬取12306网页信息，并提交相关参数，从而成功购票。

## 快速使用

将本仓库的所有文件下载下来，运行`12306_buyTickets.py`，根据程序输出的提示操作，即可完成购票订单生成。本程序没有做支付流程，故仍然需要在12306的网页端或者APP上的“我的订单”的“待支付”中找到生成的订单，并支付。

## 文件说明

购票时需要运行的程序只有`12306_buyTickets.py`。

`station_code.py`用于获得全国所有火车站的站名和其电报码的对应关系，如“上海虹桥”站的电报码为“AOH”。`station_code.txt`和`station_code.xlsx`都是火车站站名和电报码的对应文件，有这样两个文件存放相同内容的数据，只是为了好看而已。由于12306购票时，网页提交的与火车站有关的参数，大多不是车站名，而是车站的电报码，所以必须首先获得车站名和电报码的对应关系。

**运行脚本的顺序为：先运行`station_code.py`以获得`station_code.xlsx`，再运行`12306_buyTickets.py`购票。由于本仓库已经给出`station_code.xlsx`，所以仅运行`12306_buyTickets.py`而不用运行`station_code.py`也是可以的。**

`train_info各项名称含义.xlsx`中，有爬取下来的查询到的所有符合条件车次的信息，以及每一个有用的项所代表的含义。每个车次一共有58项信息，不少项的信息好像是没用的。不同项的信息分别代表什么，比如日期、是否可以预订、二等座余票等，需要根据网页前端的信息来找规律发现。在文末给出的两个参考资料中，都有提及如何找规律。

## 购票步骤

整个程序的购票步骤可以分为以下几个部分：

### 登录

如果之前有登录过，存下了`cookie.txt`，那么可以直接读取其中的cookie免二维码扫描地登录。如果没有存下`cookie.txt`或者cookie已经过期，那么程序会生成登录二维码（相当于12306网页版的“扫码登录”）`login.png`。用户用登录了自己账号的12306手机APP扫描这个二维码即可成功登录到12306网站。

> `cookies.txt`和`login.png`默认都存放在`12306_buyTickets.py`的同级目录中。

登录成功后，程序会输出：
```
登录成功！
用户名：<你的用户名>
```

### 输出查询到的符合条件的所有车次

在`12306_buyTickets.py`代码中找到以下语句：

```python
train_date,  from_station_name, to_station_name, seat_class, choose_seats = '2025-03-20', '长沙', '合肥', '二等座', None
```

在这个语句中可以修改你需要查询的车票的信息：出发日期、出发站、到达站、座位类别（二等座、一等座等）、座位号。

日期需要写成类似`2025-03-20`的形式。

出发站和到达站不需要写出“站”字。程序没有检测站名是否合法，所以请注意输入真实存在的站名。

目前程序支持的座位类别有：硬座、硬卧、软卧、商务座、一等座、二等座，它们分别都有对应的座位类别代号，可在`12306_buyTickets.py`中查询`seat_classes`看见相关信息。不过**在输出查询到的车次信息时，只输出二等座、一等座、商务座的信息，故使用者尽量只在本程序购买这3种座位。**

另外，**本程序只能购买成人票**，不支持学生票的票种的购买。

注意本程序没有检测座位号是否合法，也就是说你需要输入列车中真的存在的座位号，有的车一排只有4个座位，有的有5个，高铁没有E号座位，一排5座的只有A, B, C, D, F号座位。如果座位号`choose_seats`为`None`，则代表让12306给你随机分配座位号，这是最不会出错的方法。

输出的查询到的符合条件的所有车次的信息类似下面的内容：

```
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|  序号  | 列车号   | 出发站   | 到达站   | 出发时间   | 到达时间   | 二等座   | 一等座   | 商务座   |
+========+==========+==========+==========+============+============+==========+==========+==========+
|   1    | G1778    | 长沙南   | 合肥南   | 07:31      | 11:19      | 有       | 3        | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   2    | G1784    | 长沙南   | 合肥南   | 08:12      | 11:44      | 有       | 1        | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   3    | G1554    | 长沙南   | 合肥南   | 09:06      | 12:37      | 3        | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   4    | G1746    | 长沙南   | 合肥南   | 09:50      | 13:43      | 1        | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   5    | G1748    | 长沙南   | 合肥     | 10:01      | 13:40      | 候补     | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   6    | G1184    | 长沙南   | 合肥南   | 11:28      | 14:55      | 20       | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   7    | G1444    | 长沙南   | 合肥南   | 12:25      | 15:34      | 候补     | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   8    | G1742    | 长沙南   | 合肥     | 12:47      | 16:31      | 有       | 有       | 5        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   9    | G1742    | 长沙南   | 合肥北城 | 12:47      | 17:06      | 有       | 有       | 3        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   10   | G1774    | 长沙南   | 合肥南   | 13:18      | 16:56      | 有       | 18       | 2        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   11   | G1546    | 长沙南   | 合肥南   | 14:01      | 17:38      | 有       | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   12   | G588     | 长沙南   | 合肥南   | 14:46      | 18:14      | 有       | 有       | 1        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   13   | G1550    | 长沙南   | 合肥南   | 15:48      | 19:37      | 有       | 有       | 3        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   14   | G1542    | 长沙南   | 合肥南   | 16:49      | 20:25      | 有       | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   15   | G1428    | 长沙南   | 合肥南   | 17:40      | 21:04      | 有       | 有       | 5        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   16   | G638     | 长沙南   | 合肥南   | 17:52      | 21:36      | 有       | 10       | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   17   | G3592    | 长沙南   | 合肥南   | 18:02      | 21:51      | 有       | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
```

### 预订车票

在输出查询到的符合条件的所有车次之后，程序会弹出提示语

```
请输入您要预订的车票是所查询到所有车次中的第几个车次（最上面的车次为第一个车次）：
```

然后你需要输入在序号范围内的一个序号，代表你想购买的车次。本程序未做所输入的序号是否越界的检查。

假设我输入了`11`，然后程序会输出下列信息（这里只是以我欲购买的车票的信息为例子，若购买其余车票，则在相关内容上会有所不同）：

```
预订成功，所预订的车票信息如下：
列车号：G1546；出发日：2025-03-20；时间：14:01-17:38；从长沙到合肥。
该账号下可以购票的乘车人有：
<乘车人1>  <乘车人2>  <乘车人3>  <更多乘车人...>
请输入需要购票的乘车人姓名（只能输入一人）：
```

为保护个人隐私，这里略去了乘车人的姓名。<乘车人1>等等其实是所登录账户中的存下的乘车人信息，这里显示的是乘车人的姓名，如“张三”、“李四”。

### 生成订单

假设在上一步的`请输入需要购票的乘车人姓名（只能输入一人）：`中我输入了“张三”。

程序会输出如下订单信息：

```
提交下单成功，二等座余票40张，排队人数0人。
选座成功！
正在生成订单，请稍候...
下单成功！订单信息如下：
2025-03-20      G1546次 长沙南站 (14:01开) --- 合肥南 (17:38到)
+--------+------------+--------------------+-------------+--------+--------+--------+----------+-------------+
| 姓名   | 证件类型   | 证件号码           |   手机号    | 票种   | 席别   |  车厢  | 席位号   | 票价 (元)   |
+========+============+====================+=============+========+========+========+==========+=============+
| 张三 | 居民身份证 | 3314***********123 | 13952301597 | 成人票 | 二等座 |   07   | 05A号    | 300.00元    |
+--------+------------+--------------------+-------------+--------+--------+--------+----------+-------------+
请在10分钟内在12306手机端或者网页端付款~
```

上述信息中，身份证号和手机号均是杜撰的，如有雷同纯属巧合。

这时你需要打开你的12306APP或者去12306的网页端，在“我的订单”中查看待支付的订单。你会在其中看见有未支付的订单，你点击支付即可成功购票。本程序没有做购票支付的过程，所以支付过程仍然要通过12306的网页或者APP进行。12306要求用户在10分钟内付款，否则付款失败。

自此，你就能成功利用本程序实现12306购票。

## 注意事项

由于12306的反爬虫机制，以及对网页刷新、支付次数的限制，本程序存在一定的缺陷。

### 程序报错

目前发现的最多的报错信息就是返回的JSON数据为空，例如`json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)`。

还有在`12306_buyTickets.py`程序的`getinitDc()`函数中的几个正则表达式语句

```python
purpose_codes = re.findall(re.compile(",'purpose_codes':'(.*?)',", re.S), html_data)[0]
train_location = re.findall(re.compile(",'train_location':'(.*?)'", re.S), html_data)[0]
key_check_isChange = re.findall(re.compile("'key_check_isChange':'(.*?)',", re.S), html_data)[0]
```

也可能会报错说返回的是空值。

我猜测这些空值的返回可能是由于网络加载问题、12306反爬虫机制。当我隔几十分钟重新运行程序，就没有报错了；或者我换用另一个乘车人购票，也没有报错。我暂时没有细究其中的原因。

### 支付取消次数过多

12306只允许一个账户一天之内取消3次支付，似乎不按“取消支付”键，而等10分钟都不支付、它自动取消支付时也算一次取消支付。

当遇到这个问题时，有时程序会报错说JSON数据为空；或者当生成订单失败时，我也设置了诸如`print("生成订单失败，错误信息：", r)`的语句，来查看JSON数据里面有什么（此处的`r`就是JSON数据），里面可能会说“用户当日取消支付次数过多”等类似意思的话语。

## 环境依赖

requirements.txt:
```
pandas==2.0.3
Pillow==9.4.0
Requests==2.32.3
tabulate==0.8.10
urllib3==1.26.16
```

程序在2025年3月8日在`Python 3.11.4`中运行成功。由于12306的反爬虫机制、网页的参数都在改变，所以本程序可能具有一定的时效性，未来未必能成功运行。

## 参考资料

本程序的参考资料有2个：

- https://www.tnblog.net/cz/article/details/162 和 https://www.tnblog.net/cz/article/details/241。 这两个链接的文章给予了大量代码方面的支持，它的实现似乎比黄永祥书的代码要好，但是也有参考书的代码。

- 《实战Python网络爬虫》，黄永祥著，第19章“实战：12306抢票爬虫”。在分析url、网页请求的参数之找规律、推断网页请求的参数的意义、网页请求参数的意义解释方面，书给予了极大帮助。

但比较遗憾的是，由于上述两个参考资料都是2019年的，距离编写本程序的年份2025年已经比较久远，其中的一些网页参数已经发生改变（虽然大体上是不变的），直接运行他们的程序会失败。所以仍然需要我重新分析一次网页，来制作这样一个购票程序。

## 程序的所有输入输出展示

下面展示使用了cookie免扫描二维码登录时，程序的输出信息。其中有叫用户输入信息的地方，也一并将输入的信息展示在下面。

为了保护隐私，其中所有的姓名均用`<化名>`的形式呈现。身份证号和手机号均为杜撰，如有雷同纯属巧合。
```
登录成功！
用户名： <张三>
查询到的所有车次信息如下：
d:\爬虫\12306抢票\12306_buyTickets.py:172: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  subdf.rename(columns={
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|  序号  | 列车号   | 出发站   | 到达站   | 出发时间   | 到达时间   | 二等座   | 一等座   | 商务座   |
+========+==========+==========+==========+============+============+==========+==========+==========+
|   1    | G1778    | 长沙南   | 合肥南   | 07:31      | 11:19      | 有       | 3        | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   2    | G1784    | 长沙南   | 合肥南   | 08:12      | 11:44      | 有       | 1        | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   3    | G1554    | 长沙南   | 合肥南   | 09:06      | 12:37      | 3        | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   4    | G1746    | 长沙南   | 合肥南   | 09:50      | 13:43      | 1        | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   5    | G1748    | 长沙南   | 合肥     | 10:01      | 13:40      | 候补     | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   6    | G1184    | 长沙南   | 合肥南   | 11:28      | 14:55      | 20       | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   7    | G1444    | 长沙南   | 合肥南   | 12:25      | 15:34      | 候补     | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   8    | G1742    | 长沙南   | 合肥     | 12:47      | 16:31      | 有       | 有       | 5        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   9    | G1742    | 长沙南   | 合肥北城 | 12:47      | 17:06      | 有       | 有       | 3        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   10   | G1774    | 长沙南   | 合肥南   | 13:18      | 16:56      | 有       | 18       | 2        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   11   | G1546    | 长沙南   | 合肥南   | 14:01      | 17:38      | 有       | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   12   | G588     | 长沙南   | 合肥南   | 14:46      | 18:14      | 有       | 有       | 1        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   13   | G1550    | 长沙南   | 合肥南   | 15:48      | 19:37      | 有       | 有       | 3        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   14   | G1542    | 长沙南   | 合肥南   | 16:49      | 20:25      | 有       | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   15   | G1428    | 长沙南   | 合肥南   | 17:40      | 21:04      | 有       | 有       | 5        |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   16   | G638     | 长沙南   | 合肥南   | 17:52      | 21:36      | 有       | 10       | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
|   17   | G3592    | 长沙南   | 合肥南   | 18:02      | 21:51      | 有       | 候补     | 候补     |
+--------+----------+----------+----------+------------+------------+----------+----------+----------+
请输入您要预订的车票是所查询到所有车次中的第几个车次（最上面的车次为第一个车次）：11
预订成功，所预订的车票信息如下：
列车号：G1546；出发日：2025-03-20；时间：14:01-17:38；从长沙到合肥。
该账号下可以购票的乘车人有：
<张三>  <李四>  <王五>
请输入需要购票的乘车人姓名（只能输入一人）：<张三>
提交下单成功，二等座余票40张，排队人数0人。
选座成功！
正在生成订单，请稍候...
下单成功！订单信息如下：
2025-03-20      G1546次 长沙南站 (14:01开) --- 合肥南 (17:38到)
+--------+------------+--------------------+-------------+--------+--------+--------+----------+-------------+
| 姓名   | 证件类型   | 证件号码           |   手机号    | 票种   | 席别   |  车厢  | 席位号   | 票价 (元)   |
+========+============+====================+=============+========+========+========+==========+=============+
| <张三> | 居民身份证 | 3314***********123 | 13952301597 | 成人票 | 二等座 |   07   | 05A号    | 300.00元    |
+--------+------------+--------------------+-------------+--------+--------+--------+----------+-------------+
请在10分钟内在12306手机端或者网页端付款~
```

## 一些感受...

这是我第一次制作爬虫程序，我是初学者，之前也没有写过前后端。这个程序耗费我5天左右的时间编写完成，其中有很多知识都是现学现用。之前也不是很会浏览器的F12的使用，对计算机网络的原理知之甚少，现在我终于会一些了，还会用Fiddler抓包等等。之前也看过爬虫的原理，但是原理看多了不如一次实战，实战让我掌握知识更加牢固、熟练。